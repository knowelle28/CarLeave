{% extends "base.html" %}
{% block title %}{{ 'Ø¥Ø¯Ø§Ø±Ø© Ù…ÙƒØªØ¨ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©' if session.get('lang') == 'ar' else 'Help Desk Admin' }}{% endblock %}
{% block content %}
{% set ar = session.get('lang') == 'ar' %}

<div class="page-header">
  <div>
    <h1 class="page-title">{{ 'Ø¥Ø¯Ø§Ø±Ø© Ù…ÙƒØªØ¨ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©' if ar else 'Help Desk Admin' }}</h1>
    <p class="page-subtitle">{{ 'Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ°Ø§ÙƒØ±' if ar else 'All tickets' }} ({{ tickets | length }})</p>
  </div>
  <div style="display:flex;gap:0.5rem;">
    <a href="{{ url_for('helpdesk.admin_categories') }}" class="btn btn-outline btn-sm">ğŸ· {{ 'Ø§Ù„ÙØ¦Ø§Øª' if ar else 'Categories' }}</a>
    <a href="{{ url_for('helpdesk.admin_staff') }}" class="btn btn-outline btn-sm">ğŸ‘¥ {{ 'ÙØ±ÙŠÙ‚ Ø§Ù„Ø¯Ø¹Ù…' if ar else 'Staff' }}</a>
    <a href="{{ url_for('helpdesk.admin_reports') }}" class="btn btn-outline btn-sm">ğŸ“Š {{ 'Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±' if ar else 'Reports' }}</a>
  </div>
</div>

<!-- Filters -->
<div style="display:flex;gap:1rem;margin-bottom:1rem;flex-wrap:wrap;align-items:center;">
  <!-- Department -->
  <form method="GET" action="{{ url_for('helpdesk.admin_dashboard') }}" style="display:flex;gap:0.5rem;flex-wrap:wrap;align-items:center;">
    <input type="hidden" name="status" value="{{ status_filter }}">
    <input type="hidden" name="priority" value="{{ priority_filter }}">
    <select name="department" class="form-input form-select" style="max-width:200px;padding:0.4rem 0.75rem;font-size:0.82rem;"
            onchange="this.form.submit()">
      <option value="all" {% if dept_filter == 'all' %}selected{% endif %}>
        {{ 'ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…' if ar else 'All Departments' }}
      </option>
      {% for d in departments %}
      <option value="{{ d }}" {% if dept_filter == d %}selected{% endif %}>{{ d }}</option>
      {% endfor %}
    </select>
    <!-- Priority -->
    <select name="priority" class="form-input form-select" style="max-width:160px;padding:0.4rem 0.75rem;font-size:0.82rem;"
            onchange="this.form.submit()">
      {% for p, label_en, label_ar in [
          ('all','All Priorities','ÙƒÙ„ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ§Øª'),
          ('urgent','Urgent','Ø¹Ø§Ø¬Ù„Ø©'),
          ('high','High','Ø¹Ø§Ù„ÙŠØ©'),
          ('normal','Normal','Ø¹Ø§Ø¯ÙŠØ©'),
          ('low','Low','Ù…Ù†Ø®ÙØ¶Ø©')
      ] %}
      <option value="{{ p }}" {% if priority_filter == p %}selected{% endif %}>{{ label_ar if ar else label_en }}</option>
      {% endfor %}
    </select>
  </form>
</div>

<!-- Status tabs -->
<div class="filter-tabs">
  {% for s, label_en, label_ar in [
      ('all','All','Ø§Ù„ÙƒÙ„'),
      ('open','Open','Ù…ÙØªÙˆØ­'),
      ('in_progress','In Progress','Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©'),
      ('resolved','Resolved','Ù…Ø­Ù„ÙˆÙ„'),
      ('closed','Closed','Ù…ØºÙ„Ù‚')
  ] %}
  <a href="{{ url_for('helpdesk.admin_dashboard', status=s, priority=priority_filter, department=dept_filter) }}"
     class="filter-tab {% if status_filter == s %}active{% endif %}">
    {{ label_ar if ar else label_en }}
  </a>
  {% endfor %}
</div>

{% if tickets %}
<div class="table-card">
  <table class="table">
    <thead>
      <tr>
        <th>{{ 'Ø±Ù‚Ù… Ø§Ù„ØªØ°ÙƒØ±Ø©' if ar else 'Ticket No.' }}</th>
        <th>{{ 'Ù…Ù‚Ø¯Ù… Ø¨ÙˆØ§Ø³Ø·Ø©' if ar else 'Requester' }}</th>
        <th>{{ 'Ø§Ù„Ø¹Ù†ÙˆØ§Ù†' if ar else 'Title' }}</th>
        <th>{{ 'Ø§Ù„ÙØ¦Ø© / Ø§Ù„Ù‚Ø³Ù…' if ar else 'Category / Dept' }}</th>
        <th>{{ 'Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©' if ar else 'Priority' }}</th>
        <th>{{ 'Ø§Ù„Ø­Ø§Ù„Ø©' if ar else 'Status' }}</th>
        <th>{{ 'Ù…Ø³Ù†Ø¯ Ø¥Ù„Ù‰' if ar else 'Assigned' }}</th>
        <th>{{ 'Ø§Ù„ØªØ­Ø¯ÙŠØ«' if ar else 'Updated' }}</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      {% for t in tickets %}
      <tr>
        <td><span class="mono" style="font-weight:700;color:var(--accent);">{{ t.ticket_number }}</span></td>
        <td style="font-size:0.875rem;">{{ t.created_by_name_ar if ar and t.created_by_name_ar else t.created_by_name }}</td>
        <td>{{ t.title_ar if ar and t.title_ar else t.title }}</td>
        <td style="font-size:0.82rem;color:var(--text-muted);">
          {{ t.category.name_ar if ar and t.category.name_ar else t.category.name }}<br>
          <span style="font-size:0.75rem;">{{ t.category.department }}</span>
        </td>
        <td><span class="badge {{ t.priority_badge_class() }}">
          {% if ar %}
            {% if t.priority == 'low' %}Ù…Ù†Ø®ÙØ¶Ø©{% elif t.priority == 'normal' %}Ø¹Ø§Ø¯ÙŠØ©{% elif t.priority == 'high' %}Ø¹Ø§Ù„ÙŠØ©{% else %}Ø¹Ø§Ø¬Ù„Ø©{% endif %}
          {% else %}
            {{ t.priority | title }}
          {% endif %}
        </span></td>
        <td><span class="badge {{ t.status_badge_class() }}">
          {% if ar %}
            {% if t.status == 'open' %}Ù…ÙØªÙˆØ­{% elif t.status == 'in_progress' %}Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©{% elif t.status == 'resolved' %}Ù…Ø­Ù„ÙˆÙ„{% else %}Ù…ØºÙ„Ù‚{% endif %}
          {% else %}
            {{ t.status.replace('_',' ') | title }}
          {% endif %}
        </span></td>
        <td style="font-size:0.82rem;color:var(--text-muted);" class="mono">
          {{ t.assigned_to_username or 'â€”' }}
        </td>
        <td style="color:var(--text-muted);font-size:0.82rem;">{{ t.updated_at.strftime('%d %b %Y') }}</td>
        <td>
          <a href="{{ url_for('helpdesk.ticket_detail', id=t.id) }}" class="btn btn-ghost btn-sm">
            {{ 'â† Ø¹Ø±Ø¶' if ar else 'View â†’' }}
          </a>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% else %}
<div class="empty-state">
  <div class="empty-icon">ğŸ«</div>
  <h3>{{ 'Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ°Ø§ÙƒØ±' if ar else 'No tickets' }}</h3>
  <p>{{ 'Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ°Ø§ÙƒØ± ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ù…Ø±Ø´Ø­Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©.' if ar else 'No tickets match the current filters.' }}</p>
</div>
{% endif %}

{% endblock %}
